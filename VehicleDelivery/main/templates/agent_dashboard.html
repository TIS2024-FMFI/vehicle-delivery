<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    {% load static %}
    {% load i18n %}
    <link rel="stylesheet" href="{% static 'DashboardCSST.css' %}">
</head>
<body>
    <header>
        <div class="logo">CEVA Logistics</div>
        <button class="logout">{% trans "Logout" %}</button>
    </header>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <form method="get" class="filter-form">
                <h3>{% trans "Filters" %}</h3>

                <!-- Date From -->
                <div class="filter-item">
                    <label for="date_from">{% trans "Date from" %}</label>
                    <input type="date" id="date_from" name="date_from" value="{{ filters.date_from }}">
                </div>

                <!-- Date To -->
                <div class="filter-item">
                    <label for="date_to">{% trans "Date to" %}</label>
                    <input type="date" id="date_to" name="date_to" value="{{ filters.date_to }}">
                </div>

                <!-- ID -->
                <div class="filter-item">
                    <label for="id">ID</label>
                    <input type="text" id="id" name="id" value="{{ filters.id }}">
                </div>

                <!-- VIN -->
                <div class="filter-item">
                    <label for="vin">VIN</label>
                    <input type="text" id="vin" name="vin" value="{{ filters.vin }}">
                </div>

                <!-- Name -->
                <div class="filter-item">
                    <label for="name">{% trans "Name" %}</label>
                    <input type="text" id="name" name="name" value="{{ filters.first_name }}">
                </div>

                <!-- Email -->
                <div class="filter-item">
                    <label for="email">Email</label>
                    <input type="text" id="email" name="email" value="{{ filters.email }}">
                </div>

                <!-- Dropdown for Type -->
                <div class="filter-item">
                    <label for="type">{% trans "Type" %}</label>
                    <select id="typeReport" name="type">
                        <option value="" disabled {% if not filters.type %}selected{% endif %}>Select Type</option>
                        {% for code, label in report_types %}
                            <option value="{{ code }}" {% if filters.type == code %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="filter-button">{% trans "Filter" %}</button>

                <!-- Clear Filters -->
                <a href="{% url 'agent_dashboard' %}" class="clear-button">{% trans "Clear Filters" %}</a>
            </form>
        </div>

        <!-- Content -->
        <div class="content">
            <div class="tabs">
                <button class="tab-button {% if request.GET.status == 'new' %}active{% endif %}" onclick="filterByStatus('new')">{% trans "New" %}</button>
                <button class="tab-button {% if request.GET.status == 'opened' %}active{% endif %}" onclick="filterByStatus('opened')">{% trans "Opened" %}</button>
                <button class="tab-button {% if request.GET.status == 'archive' %}active{% endif %}" onclick="filterByStatus('archive')">{% trans "Archived" %}</button>
            </div>

            <script>
                function filterByStatus(status) {
                    // Get current URL parameters
                    let params = new URLSearchParams(window.location.search);

                    // Set the new status (or change it)
                    params.set('status', status);

                    // Preserve other query parameters
                    window.location.search = params.toString();  // Update the URL with new parameters
                }
            </script>

            <div class="table-action">
                <button type="button" id="moveButton" class="move-button">{% trans "Move to" %}</button>
                <div id="statusDropdown" style="display: none;">
                    <select id="new_status">
                        <option value="" disabled selected>Select a status</option>
                        <option value="new">{% trans "New" %}</option>
                        <option value="opened">{% trans "Opened" %}</option>
                        <option value="archive">{% trans "Archived" %}</option>
                    </select>
                </div>
            </div>

            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script>
                // Toggle visibility of the status dropdown
                document.getElementById("moveButton").addEventListener("click", function() {
                    var dropdown = document.getElementById("statusDropdown");
                    dropdown.style.display = dropdown.style.display === "none" ? "block" : "none";
                });

                document.getElementById("new_status").addEventListener("change", function () {
                    var selectedStatus = this.value; // Get the selected status
                    var selectedEntries = [];

                    // Collect selected checkbox values
                    document.querySelectorAll('.entry-checkbox:checked').forEach(function (checkbox) {
                        selectedEntries.push(checkbox.value);
                    });

                    // Check if any checkboxes are selected
                    if (selectedEntries.length > 0) {
                        // Send AJAX request to update statuses
                        $.ajax({
                            url: '{% url "update_status" %}', // Update with the correct URL
                            type: 'POST',
                            data: {
                                'type' :  document.getElementById("typeReport").value,
                                'new_status': selectedStatus,
                                'selected_entries': JSON.stringify(selectedEntries), // Serialize the array as JSON
                                'csrfmiddlewaretoken': '{{ csrf_token }}' // Include CSRF token
                            },
                            success: function (response) {
                                alert('Status updated successfully!');
                                location.reload(); // Reload the page (optional)
                            },
                            error: function (xhr, status, error) {
                                alert('Error updating status.');
                            }
                        });
                    } else {
                        alert('Please select at least one entry.');
                    }
                });
            </script>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th></th>
                            <th>#</th>
                            <th>{% trans "Firm" %}</th>
                            <th>{% trans "Full name" %}</th>
                            <th>{% trans "Date" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in entries %}
                            <tr>
                                <td><input type="checkbox" class="entry-checkbox" value="{{ entry.id }}"></td>
                                <td><a href="{% url 'entry_detail' entry.id filters.type %}">{{entry.id}}</a></td>
                                <td><a href="{% url 'entry_detail' entry.id filters.type  %}">{{entry.firm_name}}</a></td>
                                <td><a href="{% url 'entry_detail' entry.id filters.type  %}">{{entry.first_name}} {{entry.second_name}}</a></td>
                                <td><a href="{% url 'entry_detail' entry.id filters.type  %}">{{entry.date}}</a></td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="3">{% trans "No entries found matching the criteria." %}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <script>
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', function () {
                        const row = this.closest('tr');
                        if (this.checked) {
                            row.style.backgroundColor = '#dceeff'; // Light blue
                        } else {
                            row.style.backgroundColor = ''; // Reset
                        }
                    });
                });
            </script>
        </div>
    </div>
</body>
</html>
